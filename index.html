<!DOCTYPE html>
<html lang="en">
<!--
  ============================================================================
  INVOICER - Professional Invoice Generator with Gmail Integration
  ============================================================================
  
  ðŸ“§ GMAIL API SETUP (FOR AUTOMATIC PDF ATTACHMENT):
  
  To enable automatic PDF email attachment, follow these steps:
  
  1. Go to Google Cloud Console:
     https://console.cloud.google.com/
  
  2. Create a New Project:
     - Click "Select a project" â†’ "NEW PROJECT"
     - Name it "Invoicer" or anything you like
     - Click "CREATE"
  
  3. Enable Gmail API:
     - Go to "APIs & Services" â†’ "Library"
     - Search for "Gmail API"
     - Click on it and click "ENABLE"
  
  4. Create OAuth 2.0 Credentials:
     - Go to "APIs & Services" â†’ "Credentials"
     - Click "CREATE CREDENTIALS" â†’ "OAuth client ID"
     - Configure consent screen if prompted:
       * User Type: External
       * App name: Invoicer
       * User support email: your email
       * Add scope: .../auth/gmail.send
       * Add test users: your Gmail address
     - Application type: "Web application"
     - Name: "Invoicer"
     - Authorized JavaScript origins: 
       * http://localhost
       * http://127.0.0.1
       * (Add your domain if hosted online)
     - Click "CREATE"
  
  5. Copy Your Client ID:
     - Copy the "Client ID" (looks like: xxxxx.apps.googleusercontent.com)
  
  6. Update the Code:
     - Find line ~1243: CLIENT_ID: 'YOUR_CLIENT_ID_HERE...'
     - Replace with your actual Client ID
     - Save the file
  
  7. That's it!
     - Click "Connect Gmail"
     - Sign in with your Google account
     - Click "Send via Gmail" - PDF attaches automatically!
  
  âš ï¸ WITHOUT SETUP: The app still works! It downloads PDF and opens Gmail,
     you just need to attach the PDF manually (takes 5 seconds).
  
  ============================================================================
-->
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Invoicer â€“ Professional Invoice Generator</title>
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' rx='20' fill='%231e293b'/%3E%3Ctext x='50' y='70' font-family='Arial, sans-serif' font-size='48' font-weight='900' fill='%23ffffff' text-anchor='middle' letter-spacing='-4'%3EIN%3C/text%3E%3C/svg%3E" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <script src="https://apis.google.com/js/api.js"></script>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <style>
    :root {
      --ink: #1e293b;        /* slate-800 */
      --ink-light: #334155;  /* slate-700 */
      --muted: #64748b;      /* slate-500 */
      --line: #e2e8f0;       /* slate-200 */
      --line-light: #f1f5f9; /* slate-100 */
      --bg: #f8fafc;         /* slate-50 */
      --card: #ffffff;       /* white */
      --accent: #1e293b;     /* black/slate-800 */
      --accent-hover: #0f172a; /* slate-900 */
      --accent-ink: #0f172a; /* slate-900 */
      --accent-light: #e2e8f0; /* slate-200 */
      --success: #10b981;
      --danger: #ef4444;
      --warning: #f59e0b;
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      background: linear-gradient(135deg, #2d3748 0%, #1a202c 100%);
      color: var(--ink);
      font: 14px/1.6 -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    .wrap {
      max-width: 1400px;
      margin: 0 auto;
      padding: 16px;
      display: grid;
      grid-template-columns: 1fr;
      gap: 16px;
      min-height: 100vh;
    }

    /* Desktop: side-by-side layout */
    @media (min-width: 1024px) {
      .wrap {
        padding: 32px 20px;
        grid-template-columns: 480px 1fr;
        gap: 24px;
      }
    }

    h1 {
      margin: 0 0 20px;
      font-size: 32px;
      font-weight: 800;
      letter-spacing: -0.5px;
      color: var(--accent-ink);
    }

    h2 {
      margin: 20px 0 12px;
      padding-bottom: 8px;
      font-size: 13px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--ink-light);
      border-bottom: 2px solid var(--line);
    }

    @media (min-width: 768px) {
      h2 {
        margin: 24px 0 16px;
        font-size: 15px;
      }
    }

    h2:first-child {
      margin-top: 0;
    }

    .card {
      background: var(--card);
      border: none;
      border-radius: 16px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1), 0 2px 8px rgba(0, 0, 0, 0.06);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      height: auto;
    }

    /* Desktop: fixed height cards */
    @media (min-width: 1024px) {
      .card {
        border-radius: 20px;
        height: calc(100vh - 64px);
      }
    }

    .card .hd {
      padding: 18px 20px;
      background: linear-gradient(135deg, var(--accent) 0%, var(--accent-hover) 100%);
      color: white;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 4px 12px rgba(15, 23, 42, 0.2);
    }

    @media (min-width: 768px) {
      .card .hd {
        padding: 24px 28px;
      }
    }

    .card .hd > div:first-child {
      font-size: 18px;
      font-weight: 800;
      letter-spacing: -0.3px;
    }

    @media (min-width: 768px) {
      .card .hd > div:first-child {
        font-size: 20px;
      }
    }

    .card .hd > div:last-child {
      background: rgba(255, 255, 255, 0.2);
      padding: 6px 14px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 700;
      backdrop-filter: blur(10px);
    }

    .card .bd {
      padding: 20px 16px;
      flex: 1;
      overflow-y: auto;
      overflow-x: hidden;
    }

    @media (min-width: 768px) {
      .card .bd {
        padding: 28px;
      }
    }

    .card.inputs .bd {
      background: white;
    }

    .card.preview .bd {
      padding: 32px;
      background: #f8fafc;
      overflow-y: auto;
      overflow-x: hidden;
    }

    /* Custom scrollbar styling */
    .card .bd::-webkit-scrollbar {
      width: 8px;
    }

    .card .bd::-webkit-scrollbar-track {
      background: transparent;
    }

    .card .bd::-webkit-scrollbar-thumb {
      background: rgba(0, 0, 0, 0.1);
      border-radius: 4px;
    }

    .card .bd::-webkit-scrollbar-thumb:hover {
      background: rgba(0, 0, 0, 0.2);
    }

    /* Firefox scrollbar */
    .card .bd {
      scrollbar-width: thin;
      scrollbar-color: rgba(0, 0, 0, 0.1) transparent;
    }

    label {
      display: block;
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.8px;
      color: var(--muted);
      margin: 0 0 8px 4px;
    }

    @media (min-width: 768px) {
      label {
        font-size: 11px;
        margin: 0 0 8px 0;
      }
    }

    input, select, textarea {
      width: 100%;
      height: 48px;
      padding: 14px 16px;
      border: 2px solid var(--line);
      border-radius: 12px;
      background: var(--card);
      font-size: 16px; /* Prevents zoom on iOS */
      font-weight: 500;
      color: var(--ink);
      transition: all 0.2s ease;
      -webkit-appearance: none;
      appearance: none;
      box-sizing: border-box;
    }

    textarea {
      height: auto;
      min-height: 80px;
    }

    @media (min-width: 768px) {
      input, select, textarea {
        height: 44px;
        padding: 12px 16px;
        font-size: 14px;
      }
      
      textarea {
        height: auto;
      }
    }

    input:hover, select:hover, textarea:hover {
      border-color: var(--accent);
    }

    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 4px var(--accent-light);
      background: white;
    }

    input[type="number"] {
      font-family: 'SF Mono', 'Monaco', 'Courier New', monospace;
      font-weight: 600;
    }

    input[type="color"] {
      padding: 6px;
      cursor: pointer;
    }

    textarea {
      resize: vertical;
      font-family: inherit;
    }

    input:disabled, 
    input[readonly] {
      background: var(--line-light);
      color: var(--muted);
      cursor: not-allowed;
      opacity: 0.8;
    }

    .row {
      display: grid;
      grid-template-columns: 1fr;
      gap: 16px;
      margin-bottom: 16px;
      align-items: start;
    }

    @media (min-width: 640px) {
      .row {
        grid-template-columns: 1fr 1fr;
      }
    }

    .row-3 {
      display: grid;
      grid-template-columns: 1fr;
      gap: 16px;
      margin-bottom: 16px;
      align-items: start;
    }

    @media (min-width: 480px) {
      .row-3 {
        grid-template-columns: 1fr 1fr;
      }
    }

    @media (min-width: 768px) {
      .row-3 {
        grid-template-columns: 1fr 1fr 1fr;
      }
    }

    .row-full {
      display: block;
      margin-bottom: 16px;
    }

    /* Ensure all form groups have consistent structure */
    .row > div,
    .row-3 > div,
    .row-full > div {
      display: flex;
      flex-direction: column;
    }

    .actions {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-top: 24px;
    }

    @media (min-width: 768px) {
      .actions {
        flex-direction: row;
        flex-wrap: wrap;
      }
    }

    button {
      cursor: pointer;
      border: none;
      background: linear-gradient(135deg, var(--accent) 0%, var(--accent-hover) 100%);
      color: white;
      padding: 16px 24px;
      border-radius: 12px;
      font-weight: 700;
      font-size: 15px;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 4px 12px rgba(15, 23, 42, 0.4);
      position: relative;
      overflow: hidden;
      min-height: 48px; /* Touch-friendly */
      -webkit-tap-highlight-color: transparent;
    }

    @media (min-width: 768px) {
      button {
        padding: 14px 24px;
        font-size: 14px;
        min-height: auto;
      }
    }

    button:before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, rgba(255,255,255,0.2) 0%, rgba(255,255,255,0) 100%);
      opacity: 0;
      transition: opacity 0.2s;
    }

    button:hover:before {
      opacity: 1;
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(15, 23, 42, 0.5);
    }

    button:active {
      transform: translateY(0);
      box-shadow: 0 2px 8px rgba(15, 23, 42, 0.4);
    }

    button.secondary {
      background: white;
      color: var(--accent);
      border: 2px solid var(--line);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }

    button.secondary:hover {
      background: var(--line-light);
      border-color: var(--accent);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    button.danger {
      background: linear-gradient(135deg, var(--danger) 0%, #dc2626 100%);
      box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
    }

    button.danger:hover {
      box-shadow: 0 6px 16px rgba(239, 68, 68, 0.4);
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none !important;
    }

    .muted {
      color: var(--muted);
    }

    .section-divider {
      border: none;
      border-top: 2px solid var(--line);
      margin: 32px 0;
    }

    .line-items {
      margin: 20px 0;
    }

    .line-item {
      background: white;
      border: 2px solid var(--line);
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 16px;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
    }

    @media (min-width: 768px) {
      .line-item {
        padding: 24px 28px;
      }
    }

    .line-item:hover {
      border-color: var(--accent);
      box-shadow: 0 8px 24px rgba(15, 23, 42, 0.12);
      transform: translateY(-2px);
    }

    .line-item-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 16px;
      border-bottom: 2px solid var(--line-light);
    }

    .line-item-title {
      font-weight: 700;
      font-size: 14px;
      color: var(--ink-light);
      display: flex;
      align-items: center;
      gap: 10px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    @media (min-width: 768px) {
      .line-item-title {
        font-size: 15px;
      }
    }

    .line-item-actions {
      display: flex;
      gap: 8px;
    }

    .line-item-actions button {
      padding: 8px 18px;
      font-size: 13px;
      font-weight: 600;
      box-shadow: none;
      background: white;
      color: var(--danger);
      border: 2px solid var(--line);
      min-height: 36px;
    }

    .line-item-actions button:hover {
      background: var(--danger);
      color: white;
      border-color: var(--danger);
      transform: none;
    }

    @media (min-width: 768px) {
      .line-item-actions button {
        padding: 8px 20px;
      }
    }

    .badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, var(--accent) 0%, var(--accent-hover) 100%);
      color: white;
      min-width: 28px;
      height: 28px;
      padding: 0 10px;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 800;
      box-shadow: 0 2px 8px rgba(15, 23, 42, 0.3);
    }

    /* Invoice preview styles */
    .sheet {
      background: white;
      border: none;
      border-radius: 8px;
      padding: 40px 32px 80px 32px;
      width: 100%;
      max-width: 100%;
      min-height: auto;
      margin: 0 auto;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
      position: relative;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      text-rendering: optimizeLegibility;
      display: flex;
      flex-direction: column;
    }

    @media (min-width: 768px) {
      .sheet {
        border-radius: 12px;
        padding: 48px 40px 100px 40px;
      }
    }

    @media (min-width: 1024px) {
      .sheet {
        padding: 60px 60px 120px 60px;
        width: 210mm;
        min-height: 297mm;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12);
      }
    }

    .inv-header {
      display: flex;
      flex-direction: column;
      gap: 24px;
      margin-bottom: 40px;
      padding-bottom: 24px;
      border-bottom: 3px solid var(--line);
    }

    @media (min-width: 768px) {
      .inv-header {
        flex-direction: row;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 48px;
        padding-bottom: 28px;
      }
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .brand-badge {
      width: 64px;
      height: 64px;
      border-radius: 16px;
      background: var(--accent);
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
      font-weight: 900;
      font-size: 22px;
      letter-spacing: -1px;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
    }

    .brand-badge svg {
      width: 44px;
      height: 44px;
    }

    .brand-title {
      font-weight: 900;
      font-size: 26px;
      color: var(--accent-ink);
      letter-spacing: 0.5px;
    }

    @media (min-width: 768px) {
      .brand-badge {
        width: 72px;
        height: 72px;
      }

      .brand-badge svg {
        width: 48px;
        height: 48px;
      }

      .brand-title {
        font-size: 32px;
      }
    }

    .meta {
      width: 100%;
      min-width: auto;
    }

    @media (min-width: 768px) {
      .meta {
        min-width: 380px;
        width: auto;
      }
    }

    .meta .rowx {
      display: flex;
      border-bottom: 1px solid var(--line);
      padding: 12px 0;
    }

    .meta .rowx > div:first-child {
      width: 45%;
      font-weight: 700;
      color: var(--muted);
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .meta .rowx > div:last-child {
      flex: 1;
      text-align: right;
      font-weight: 700;
      color: var(--ink);
      font-size: 15px;
    }

    @media (min-width: 768px) {
      .meta .rowx {
        padding: 14px 0;
      }

      .meta .rowx > div:first-child {
        font-size: 14px;
      }

      .meta .rowx > div:last-child {
        font-size: 16px;
      }
    }

    .meta .rowx:last-child {
      border-bottom: none;
    }

    .grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 24px;
      margin: 32px 0 40px 0;
    }

    .panel {
      border: 2px solid var(--line);
      border-radius: 16px;
      padding: 20px;
      background: #fafbff;
    }

    .panel .title {
      font-weight: 800;
      color: var(--muted);
      margin-bottom: 12px;
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.8px;
    }

    .panel .content {
      font-weight: 600;
      line-height: 1.8;
      color: var(--ink);
      font-size: 14px;
    }

    @media (min-width: 768px) {
      .panel {
        padding: 24px;
      }

      .panel .title {
        font-size: 14px;
        margin-bottom: 14px;
      }

      .panel .content {
        font-size: 15px;
        line-height: 1.9;
      }
    }

    /* Table wrapper for mobile scroll */
    .table-wrapper {
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      margin: 16px 0;
    }

    table {
      width: 100%;
      min-width: 600px;
      border-collapse: separate;
      border-spacing: 0;
      border: 2px solid var(--line);
      border-radius: 12px;
      overflow: hidden;
      font-size: 13px;
      margin: 32px 0;
    }

    @media (min-width: 768px) {
      table {
        min-width: 100%;
        border-radius: 14px;
        margin: 40px 0;
        font-size: 14px;
      }
    }

    th, td {
      padding: 14px 12px;
      border-bottom: 1px solid var(--line);
      text-align: left;
    }

    @media (min-width: 768px) {
      th, td {
        padding: 16px 18px;
      }
    }

    thead th {
      background: var(--ink);
      color: #fff;
      font-weight: 700;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    @media (min-width: 768px) {
      thead th {
        font-size: 13px;
      }
    }

    tbody tr:last-child td {
      border-bottom: none;
    }

    tbody tr:hover {
      background: #fafbff;
    }

    td.right, th.right {
      text-align: right;
    }

    td.currency {
      font-family: 'Courier New', monospace;
      font-weight: 600;
    }

    .totals {
      display: flex;
      justify-content: flex-end;
      margin-top: 32px;
      margin-bottom: 32px;
    }

    @media (min-width: 768px) {
      .totals {
        margin-top: 40px;
        margin-bottom: 48px;
      }
    }

    .totals .box {
      width: 100%;
      min-width: auto;
      border: 1px solid var(--ink);
      border-radius: 12px;
      overflow: hidden;
    }

    @media (min-width: 768px) {
      .totals .box {
        min-width: 360px;
        width: auto;
        border-radius: 14px;
      }
    }

    .totals .box .rowy {
      display: flex;
      justify-content: space-between;
      padding: 12px;
      border-bottom: 1px solid var(--line);
      background: #fff;
      font-size: 14px;
    }

    @media (min-width: 768px) {
      .totals .box .rowy {
        padding: 14px;
        font-size: 15px;
      }
    }

    .totals .box .rowy:nth-child(odd) {
      background: #fafbff;
    }

    .totals .box .rowy span:last-child {
      font-family: 'Courier New', monospace;
      font-weight: 600;
    }

    .totals .box .rowy:last-child {
      border-bottom: none;
      background: var(--accent-ink);
      color: #fff;
      font-weight: 800;
      font-size: 16px;
    }

    .totals .box .rowy:last-child span:last-child {
      color: #fff;
    }

    .note {
      margin-top: 32px;
      margin-bottom: 32px;
      border: 2px dashed var(--line);
      border-radius: 14px;
      padding: 20px;
      color: var(--muted);
      background: #fafbff;
      font-size: 13px;
      line-height: 1.8;
    }

    @media (min-width: 768px) {
      .note {
        margin-top: 40px;
        margin-bottom: 40px;
        padding: 24px;
        font-size: 14px;
      }
    }

    .invoice-footer {
      margin-top: 60px;
      padding: 32px 0 0 0;
      border-top: 3px solid var(--line);
      text-align: center;
    }

    .invoice-footer p {
      margin: 0;
      font-size: 13px;
      color: var(--muted);
      font-weight: 600;
    }

    .invoice-footer span {
      color: var(--accent);
      font-weight: 700;
    }

    @media (min-width: 768px) {
      .invoice-footer {
        margin-top: 80px;
        padding: 36px 0 0 0;
      }

      .invoice-footer p {
        font-size: 14px;
      }
    }

    .empty-state {
      text-align: center;
      padding: 80px 40px;
      color: var(--muted);
    }

    .empty-state-icon {
      font-size: 64px;
      margin-bottom: 16px;
      opacity: 0.5;
    }

    .empty-state p {
      font-size: 16px;
      font-weight: 600;
    }

    .validation-error {
      color: var(--danger);
      font-size: 12px;
      margin-top: 4px;
    }

    /* --- Print control --- */
    @page {
      size: A4;
      margin: 0;
    }

    @media print {
      html, body {
        height: auto;
        margin: 0;
        padding: 0;
      }

      body {
        background: white !important;
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
        color-adjust: exact;
      }
      
      * {
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
        color-adjust: exact !important;
      }

      .wrap {
        display: block;
        margin: 0;
        padding: 0;
        max-width: 100%;
        background: white;
      }

      .card.inputs {
        display: none !important;
      }

      .card.preview {
        border: none !important;
        box-shadow: none !important;
        border-radius: 0 !important;
        background: white !important;
        margin: 0;
        padding: 0;
      }

      .card.preview .bd {
        padding: 0 !important;
      }

      .sheet {
        border: none !important;
        border-radius: 0 !important;
        box-shadow: none !important;
        max-width: 100% !important;
        width: 210mm !important;
        min-height: 297mm !important;
        margin: 0 auto !important;
        padding: 20mm 20mm 15mm 20mm !important;
        background: white !important;
      }

      .actions, .toolbar {
        display: none !important;
      }

      /* Ensure proper page breaks */
      .inv-header, .grid, table, .totals {
        page-break-inside: avoid;
      }

      /* Ensure logo prints correctly */
      .brand-badge svg {
        color: white !important;
        stroke: white !important;
      }

      /* Footer for print */
      .invoice-footer {
        margin-top: 60px !important;
        padding-top: 32px !important;
        border-top: 3px solid var(--line) !important;
        page-break-before: avoid;
      }

      /* Hide modal in print */
      .modal {
        display: none !important;
      }
    }

    /* Modal Styles */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(4px);
      z-index: 10000;
      animation: fadeIn 0.2s ease-out;
    }

    .modal.show {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
      }
      to {
        opacity: 1;
      }
    }

    @keyframes slideUp {
      from {
        transform: translateY(20px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    .modal-content {
      background: white;
      border-radius: 20px;
      max-width: 500px;
      width: 100%;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      animation: slideUp 0.3s ease-out;
      overflow: hidden;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 28px 32px;
      border-bottom: 2px solid var(--line);
      background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
    }

    .modal-header h3 {
      margin: 0;
      font-size: 22px;
      font-weight: 800;
      color: var(--ink);
    }

    .modal-close {
      background: none;
      border: none;
      font-size: 32px;
      line-height: 1;
      color: var(--muted);
      cursor: pointer;
      padding: 0;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 8px;
      transition: all 0.2s;
    }

    .modal-close:hover {
      background: rgba(0, 0, 0, 0.05);
      color: var(--ink);
    }

    .modal-body {
      padding: 32px;
    }

    .modal-description {
      margin: 0 0 24px 0;
      color: var(--ink-light);
      font-size: 15px;
      line-height: 1.6;
    }

    .modal-input-group {
      margin-bottom: 16px;
    }

    .modal-input-group label {
      display: block;
      margin-bottom: 10px;
      font-weight: 700;
      font-size: 13px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .modal-input-group input {
      width: 100%;
      padding: 14px 16px;
      border: 2px solid var(--line);
      border-radius: 12px;
      font-size: 16px;
      font-weight: 500;
      color: var(--ink);
      transition: all 0.2s;
      box-sizing: border-box;
    }

    .modal-input-group input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 4px rgba(30, 41, 59, 0.1);
    }

    .modal-error {
      padding: 12px 16px;
      background: #fee2e2;
      border: 2px solid #ef4444;
      border-radius: 10px;
      color: #991b1b;
      font-size: 14px;
      font-weight: 600;
      margin-top: 16px;
    }

    .modal-footer {
      display: flex;
      gap: 12px;
      padding: 24px 32px 32px 32px;
      justify-content: flex-end;
    }

    .btn-secondary,
    .btn-primary {
      padding: 14px 28px;
      font-size: 15px;
      font-weight: 700;
      border-radius: 12px;
      border: none;
      cursor: pointer;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      min-height: 48px;
    }

    .btn-secondary {
      background: white;
      color: var(--ink);
      border: 2px solid var(--line);
    }

    .btn-secondary:hover {
      background: var(--line-light);
      border-color: var(--muted);
    }

    .btn-primary {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: white;
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(16, 185, 129, 0.5);
    }

    .btn-primary:active {
      transform: translateY(0);
    }

    .btn-primary:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    .btn-primary span {
      font-size: 18px;
    }

    @media (max-width: 640px) {
      .modal-content {
        border-radius: 16px;
        max-width: 100%;
      }

      .modal-header {
        padding: 20px 24px;
      }

      .modal-header h3 {
        font-size: 19px;
      }

      .modal-body {
        padding: 24px;
      }

      .modal-footer {
        padding: 20px 24px 24px 24px;
        flex-direction: column-reverse;
      }

      .btn-secondary,
      .btn-primary {
        width: 100%;
        justify-content: center;
      }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <!-- LEFT: Inputs -->
    <div class="card inputs">
      <div class="hd">
        <div>Invoicer</div>
        <div style="font-weight: 600; font-size: 12px; color: white; opacity: 0.9;">v1.0</div>
      </div>
      <div class="bd">
        <!-- Basic Info -->
        <h2>Basic Information</h2>
        <div class="row">
          <div>
            <label>Freelancer Name</label>
            <input id="in_freelancer" placeholder="Your name" value="Milad Ezzzat" />
          </div>
          <div>
            <label>Email</label>
            <input id="in_email" type="email" placeholder="your@email.com" value="miladezzat.f@gmail.com" />
          </div>
        </div>

        <div class="row-full">
          <label>Client Name</label>
          <input id="in_client" placeholder="Client name" value="Company Name" />
        </div>

        <div class="row">
          <div>
            <label>Invoice Number</label>
            <input id="in_number" placeholder="INV-0001" value="0001" />
          </div>
            <div>
            <label>Payment Terms</label>
            <select id="in_payment_terms">
              <option value="net30">Net 30</option>
              <option value="net15">Net 15</option>
              <option value="due_on_receipt" selected>Due on Receipt</option>
            </select>
            </div>
            </div>

        <div class="row">
          <div>
            <label>Invoice Date</label>
            <input id="in_date" type="date" />
          </div>
          <div>
            <label>Due Date</label>
            <input id="in_due" type="date" />
          </div>
        </div>

        <div class="row">
          <div>
            <label>Currency</label>
            <select id="in_currency">
              <option value="$" selected>$ (USD)</option>
              <option value="â‚¬">â‚¬ (EUR)</option>
              <option value="Â£">Â£ (GBP)</option>
              <option value="Â¥">Â¥ (JPY)</option>
            </select>
          </div>
          <div>
            <label>Brand Color</label>
            <input type="color" id="in_color" value="#1e293b" style="height: 44px; cursor: pointer;" />
          </div>
          </div>

        <hr class="section-divider" />

        <!-- Line Items -->
        <div style="display: flex; justify-content: space-between; align-items: center; margin: 24px 0 16px;">
          <h2 style="margin: 0; border: none; padding: 0;">Line Items</h2>
          <button id="btn_add_item" class="secondary" style="padding: 10px 20px; font-size: 13px; font-weight: 700;">
            <span style="font-size: 16px; margin-right: 4px;">+</span> Add Item
          </button>
        </div>

        <div class="line-items" id="line_items_container">
          <!-- Line items inserted here -->
        </div>

        <hr class="section-divider" />

        <!-- Totals Config -->
        <h2>Totals</h2>
        <div class="row">
          <div>
            <label>Tax (%)</label>
            <input id="in_tax" type="number" step="0.01" value="0" />
          </div>
          <div>
            <label>Discount (flat)</label>
            <input id="in_discount" type="number" step="0.01" value="0" />
          </div>
          </div>

        <div class="row-full">
          <label>Footer Notes</label>
          <textarea id="in_note" placeholder="Optional text shown under totals"></textarea>
        </div>

        <div class="actions">
          <button id="btn_update" class="secondary" type="button">
            <span style="font-size: 16px; margin-right: 6px;">â†»</span> Refresh Preview
          </button>
          <button id="btn_print" type="button">
            <span style="font-size: 16px; margin-right: 6px;">â¬‡</span> Print / PDF
          </button>
          <button id="btn_send_email" type="button" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);">
            <span style="font-size: 16px; margin-right: 6px;">âœ‰</span> Send via Gmail
          </button>
        </div>

        <!-- Gmail Connection Status -->
        <div id="gmail_status" style="margin-top: 16px; padding: 12px 16px; background: #f8fafc; border: 2px solid var(--line); border-radius: 10px; display: flex; align-items: center; justify-content: space-between;">
          <div style="display: flex; align-items: center; gap: 10px;">
            <span id="gmail_status_icon" style="font-size: 20px;">âšª</span>
            <div>
              <div id="gmail_status_text" style="font-size: 13px; font-weight: 600; color: var(--ink);">Gmail Not Connected</div>
              <div id="gmail_status_email" style="font-size: 11px; color: var(--muted); margin-top: 2px;"></div>
            </div>
          </div>
          <button id="btn_connect_gmail" type="button" style="padding: 8px 16px; font-size: 13px; min-height: 36px; background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);">
            <span style="margin-right: 6px;">ðŸ”—</span> Connect Gmail
          </button>
        </div>

        <div style="margin-top: 12px; padding: 16px; background: linear-gradient(135deg, #dbeafe 0%, #e0e7ff 100%); border-left: 4px solid var(--accent); border-radius: 10px;">
          <p style="margin: 0 0 8px 0; font-size: 14px; color: var(--ink); font-weight: 700;">
            ðŸ“¨ How to Send Invoice:
          </p>
          <ol style="margin: 0; padding-left: 20px; font-size: 13px; color: var(--ink-light); line-height: 1.8;">
            <li>Click <strong>"Connect Gmail"</strong> to authorize (one-time)</li>
            <li>Click <strong>"Send via Gmail"</strong></li>
            <li>Enter client email in the popup</li>
            <li>PDF attaches automatically and sends! âœ“</li>
          </ol>
        </div>
      </div>
    </div>

    <!-- RIGHT: Preview -->
    <div class="card preview">
      <div class="bd">
        <div class="sheet" id="preview">
          <div class="empty-state">
            <div class="empty-state-icon">ðŸ“„</div>
            <p>Loading preview...</p>
        </div>
      </div>
      </div>
    </div>
  </div>

  <!-- Email Modal -->
  <div id="emailModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>ðŸ“§ Send Invoice via Gmail</h3>
        <button class="modal-close" id="closeModal">&times;</button>
      </div>
      <div class="modal-body">
        <p class="modal-description">Enter the client's email address to send the invoice:</p>
        <div class="modal-input-group">
          <label for="modal_client_email">Client Email Address</label>
          <input 
            type="email" 
            id="modal_client_email" 
            placeholder="client@example.com" 
            autocomplete="email"
          />
        </div>
        <div id="modal_error" class="modal-error" style="display: none;"></div>
      </div>
      <div class="modal-footer">
        <button id="cancelEmailBtn" class="btn-secondary">Cancel</button>
        <button id="confirmSendBtn" class="btn-primary">
          <span>âœ‰</span> Send Invoice
        </button>
      </div>
    </div>
  </div>

  <!-- Templates -->
  <template id="tpl-invoice">
    <div>
      <!-- Header -->
      <div class="inv-header">
        <div class="brand">
          <div class="brand-badge" id="p_badge">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 60 60" width="40" height="40">
              <text x="30" y="42" font-family="Arial, sans-serif" font-size="32" font-weight="900" fill="currentColor" text-anchor="middle" letter-spacing="-2">IN</text>
            </svg>
          </div>
          <div class="brand-title">INVOICER</div>
        </div>
        <div class="meta">
          <div class="rowx"><div>Invoice #</div><div id="p_num"></div></div>
          <div class="rowx"><div>Date</div><div id="p_date"></div></div>
          <div class="rowx"><div>Due</div><div id="p_due"></div></div>
        </div>
      </div>

      <!-- Parties -->
      <div class="grid">
        <div class="panel">
          <div class="title">From</div>
          <div class="content" id="p_from"></div>
        </div>
        <div class="panel">
          <div class="title">Bill To</div>
          <div class="content" id="p_to"></div>
        </div>
      </div>

      <!-- Items Table -->
      <div class="table-wrapper">
      <table>
        <thead>
          <tr>
            <th>Description</th>
              <th>Period</th>
            <th class="right">Days</th>
            <th class="right">Hours</th>
            <th class="right">Rate</th>
            <th class="right">Amount</th>
          </tr>
        </thead>
          <tbody id="p_items">
            <!-- Items inserted here -->
        </tbody>
      </table>
      </div>

      <!-- Totals -->
      <div class="totals">
        <div class="box">
          <div class="rowy"><span>Subtotal</span><span id="p_subtotal" class="currency"></span></div>
          <div class="rowy" id="p_tax_row" style="display: none;"><span>Tax</span><span id="p_tax" class="currency"></span></div>
          <div class="rowy" id="p_discount_row" style="display: none;"><span>Discount</span><span id="p_discount" class="currency"></span></div>
          <div class="rowy"><span>Total Due</span><span id="p_total" class="currency"></span></div>
        </div>
      </div>

      <!-- Note -->
      <div class="note" id="p_note_wrap" style="display: none;"></div>

      <!-- Footer -->
      <div class="invoice-footer">
        <p>
          Powered by <span>Invoicer</span>
        </p>
      </div>
    </div>
  </template>

  <template id="tpl-line-item">
    <div class="line-item">
      <div class="line-item-header">
        <div class="line-item-title" data-index="">Item <span class="badge" data-index=""></span></div>
        <div class="line-item-actions">
          <button class="secondary" data-action="remove" style="padding: 6px 10px; font-size: 12px;">Delete</button>
        </div>
      </div>
      <div class="row-full">
        <label>Description</label>
        <input placeholder="e.g., Web Development Services" data-field="description" />
      </div>
      <div class="row">
        <div>
          <label>Period From</label>
          <input type="date" data-field="periodFrom" />
        </div>
        <div>
          <label>Period To</label>
          <input type="date" data-field="periodTo" />
        </div>
      </div>
      <div class="row-3">
        <div>
          <label>Days (optional)</label>
          <input type="number" placeholder="15" step="1" value="" data-field="days" />
        </div>
        <div>
          <label>Hours/Day (optional)</label>
          <input type="number" placeholder="8" step="0.5" value="" data-field="hoursPerDay" />
        </div>
        <div>
          <label>Total Hours</label>
          <input type="number" placeholder="120" step="0.01" value="" data-field="quantity" />
        </div>
      </div>
      <div class="row">
        <div>
          <label>Hourly Rate</label>
          <input type="number" placeholder="50.00" step="0.01" value="50.00" data-field="rate" />
        </div>
        <div>
          <label>Amount (auto)</label>
          <input type="number" step="0.01" data-field="amount" disabled />
        </div>
      </div>
    </div>
  </template>

  <script>
    // ============================================================================
    // GMAIL API CONFIGURATION
    // ============================================================================
    const GMAIL_CONFIG = {
      // OAuth 2.0 Client ID from Google Cloud Console
      // Project: my-project-82943-1733742444743
      CLIENT_ID: '813092907872-4tqnmopeusnuc0re17rc4o423f1hst7f.apps.googleusercontent.com',
      DISCOVERY_DOCS: ['https://www.googleapis.com/discovery/v1/apis/gmail/v1/rest'],
      SCOPES: 'https://www.googleapis.com/auth/gmail.send'
    };

    // Gmail OAuth State
    let gmailAuthorized = false;
    let gmailAccessToken = null;
    let gmailUserEmail = null;

    // ============================================================================
    // CONSTANTS
    // ============================================================================
    const CONFIG = {
      SELECTORS: {
        freelancer: '#in_freelancer',
        email: '#in_email',
        client: '#in_client',
        clientEmail: '#in_client_email',
        number: '#in_number',
        date: '#in_date',
        due: '#in_due',
        currency: '#in_currency',
        color: '#in_color',
        tax: '#in_tax',
        discount: '#in_discount',
        note: '#in_note',
        lineItemsContainer: '#line_items_container',
        preview: '#preview',
        updateBtn: '#btn_update',
        printBtn: '#btn_print',
        printTopBtn: '#btn_print_top',
        addItemBtn: '#btn_add_item',
        sendEmailBtn: '#btn_send_email',
        connectGmailBtn: '#btn_connect_gmail',
        gmailStatusIcon: '#gmail_status_icon',
        gmailStatusText: '#gmail_status_text',
        gmailStatusEmail: '#gmail_status_email'
      },
      DEFAULTS: {
        lineItem: { description: '', periodFrom: '', periodTo: '', days: '', hoursPerDay: '', quantity: '', rate: 100, amount: 0 }
      }
    };

    // ============================================================================
    // STATE MANAGEMENT
    // ============================================================================
    class InvoiceState {
      constructor() {
        this.lineItems = [{ ...CONFIG.DEFAULTS.lineItem }];
      }

      addLineItem() {
        this.lineItems.push({ ...CONFIG.DEFAULTS.lineItem });
        return this.lineItems.length - 1;
      }

      removeLineItem(index) {
        if (this.lineItems.length > 1) {
          this.lineItems.splice(index, 1);
          return true;
        }
        return false;
      }

      getLineItem(index) {
        return this.lineItems[index];
      }

      updateLineItem(index, field, value) {
        if (this.lineItems[index]) {
          this.lineItems[index][field] = value;
          
          // Auto-calculate total hours from days Ã— hoursPerDay
          if (field === 'days' || field === 'hoursPerDay') {
            const days = parseFloat(this.lineItems[index].days) || 0;
            const hoursPerDay = parseFloat(this.lineItems[index].hoursPerDay) || 0;
            if (days > 0 && hoursPerDay > 0) {
              this.lineItems[index].quantity = days * hoursPerDay;
            }
          }
          
          // Calculate amount from quantity Ã— rate
          if (field === 'quantity' || field === 'rate' || field === 'days' || field === 'hoursPerDay') {
            const quantity = parseFloat(this.lineItems[index].quantity) || 0;
            const rate = parseFloat(this.lineItems[index].rate) || 0;
            this.lineItems[index].amount = quantity * rate;
          }
        }
      }

      getSubtotal() {
        return this.lineItems.reduce((sum, item) => sum + (item.quantity * item.rate), 0);
      }
    }

    // ============================================================================
    // UTILITIES
    // ============================================================================
    const Utils = {
      $(selector) {
        return document.querySelector(selector);
      },

      formatMoney(amount, currency) {
        const num = Number(amount || 0);
        return `${currency}${num.toLocaleString(undefined, {
          minimumFractionDigits: 2,
          maximumFractionDigits: 2
        })}`;
      },

      shadeColor(hex, amount) {
        hex = hex.replace('#', '');
        if (hex.length === 3) {
          hex = hex.split('').map(c => c + c).join('');
        }
        const num = parseInt(hex, 16);
        let r = (num >> 16) + amount;
        let g = (num >> 8 & 0x00FF) + amount;
        let b = (num & 0x0000FF) + amount;

        r = Math.max(0, Math.min(255, r));
        g = Math.max(0, Math.min(255, g));
        b = Math.max(0, Math.min(255, b));

        return `#${(r << 16 | g << 8 | b).toString(16).padStart(6, '0')}`;
      },

      setAccentColor(hex) {
      document.documentElement.style.setProperty('--accent', hex);
        const darkHex = Utils.shadeColor(hex, -35);
        document.documentElement.style.setProperty('--accent-ink', darkHex);

        const badge = Utils.$('p_badge');
        if (badge) badge.style.background = hex;
      },

      getTodayISO() {
        return new Date().toISOString().slice(0, 10);
      }
    };

    // ============================================================================
    // INVOICE BUILDER
    // ============================================================================
    class InvoiceBuilder {
      constructor(state) {
        this.state = state;
        this.buildPreview = this.buildPreview.bind(this);
        this.setupEventListeners();
        this.renderLineItemsUI();
        this.initializeDefaults();
        this.buildPreview();
      }

      initializeDefaults() {
        const today = Utils.getTodayISO();
        Utils.$(CONFIG.SELECTORS.date).value = today;
        Utils.$(CONFIG.SELECTORS.due).value = today;
      }

      setupEventListeners() {
        // Line item management
        const addBtn = Utils.$(CONFIG.SELECTORS.addItemBtn);
        if (addBtn) addBtn.addEventListener('click', () => this.addLineItem());

        // Form inputs
        [
          CONFIG.SELECTORS.freelancer,
          CONFIG.SELECTORS.email,
          CONFIG.SELECTORS.client,
          CONFIG.SELECTORS.number,
          CONFIG.SELECTORS.date,
          CONFIG.SELECTORS.due,
          CONFIG.SELECTORS.currency,
          CONFIG.SELECTORS.color,
          CONFIG.SELECTORS.tax,
          CONFIG.SELECTORS.discount,
          CONFIG.SELECTORS.note
        ].forEach(selector => {
          const el = Utils.$(selector);
          if (el) {
            el.addEventListener('change', this.buildPreview);
            el.addEventListener('input', this.buildPreview);
          }
        });

        // Buttons
        const updateBtn = Utils.$(CONFIG.SELECTORS.updateBtn);
        if (updateBtn) updateBtn.addEventListener('click', this.buildPreview);

        const printBtn = Utils.$(CONFIG.SELECTORS.printBtn);
        if (printBtn) printBtn.addEventListener('click', () => this.print());

        const printTopBtn = Utils.$(CONFIG.SELECTORS.printTopBtn);
        if (printTopBtn) printTopBtn.addEventListener('click', () => this.print());

        const sendEmailBtn = Utils.$(CONFIG.SELECTORS.sendEmailBtn);
        if (sendEmailBtn) sendEmailBtn.addEventListener('click', () => this.showEmailModal());

        const connectGmailBtn = Utils.$(CONFIG.SELECTORS.connectGmailBtn);
        if (connectGmailBtn) connectGmailBtn.addEventListener('click', () => this.connectGmail());

        // Modal event listeners
        const closeModalBtn = document.getElementById('closeModal');
        if (closeModalBtn) closeModalBtn.addEventListener('click', () => this.closeEmailModal());

        const cancelEmailBtn = document.getElementById('cancelEmailBtn');
        if (cancelEmailBtn) cancelEmailBtn.addEventListener('click', () => this.closeEmailModal());

        const confirmSendBtn = document.getElementById('confirmSendBtn');
        if (confirmSendBtn) confirmSendBtn.addEventListener('click', () => this.confirmSendEmail());

        // Close modal on outside click
        const emailModal = document.getElementById('emailModal');
        if (emailModal) {
          emailModal.addEventListener('click', (e) => {
            if (e.target === emailModal) this.closeEmailModal();
          });
        }

        // Submit on Enter key in email input
        const modalEmailInput = document.getElementById('modal_client_email');
        if (modalEmailInput) {
          modalEmailInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') this.confirmSendEmail();
          });
        }

        // Delegate line item events
        const container = Utils.$(CONFIG.SELECTORS.lineItemsContainer);
        if (container) {
          container.addEventListener('input', (e) => {
            this.handleLineItemInput(e);
          });

          container.addEventListener('click', (e) => {
            if (e.target.dataset.action === 'remove') {
              const itemEl = e.target.closest('.line-item');
              const index = Array.from(container.children).indexOf(itemEl);
              this.removeLineItem(index);
            }
          });
        }
      }

      handleLineItemInput(event) {
        const input = event.target;
        if (!input.dataset.field) return;

        const itemEl = input.closest('.line-item');
        const index = Array.from(Utils.$(CONFIG.SELECTORS.lineItemsContainer).children).indexOf(itemEl);
        const field = input.dataset.field;
        let value = input.value;

        if (field === 'quantity' || field === 'rate' || field === 'days' || field === 'hoursPerDay') {
          value = parseFloat(value) || 0;
        }

        this.state.updateLineItem(index, field, value);

        // Update calculated fields in UI
        const item = this.state.getLineItem(index);
        const qtyInput = itemEl.querySelector('[data-field="quantity"]');
        if (qtyInput && item.quantity) qtyInput.value = item.quantity;
        
        const amountInput = itemEl.querySelector('[data-field="amount"]');
        if (amountInput) amountInput.value = item.amount;

        this.buildPreview();
      }

      addLineItem() {
        const index = this.state.addLineItem();
        this.renderLineItemsUI();
        this.buildPreview();
      }

      removeLineItem(index) {
        if (this.state.removeLineItem(index)) {
          this.renderLineItemsUI();
          this.buildPreview();
        }
      }

      renderLineItemsUI() {
        try {
          const container = Utils.$(CONFIG.SELECTORS.lineItemsContainer);
          if (!container) return;

          container.innerHTML = '';

          this.state.lineItems.forEach((item, index) => {
            const template = document.getElementById('tpl-line-item');
            if (!template) {
              console.error('Line item template not found');
              return;
            }

            const clone = document.importNode(template.content, true);

            // Set badge index (only the span, not the parent div)
            const badge = clone.querySelector('.badge[data-index]');
            if (badge) badge.textContent = index + 1;

            // Set values - with safe checks
            const descInput = clone.querySelector('[data-field="description"]');
            if (descInput) descInput.value = item.description;

            const periodFromInput = clone.querySelector('[data-field="periodFrom"]');
            if (periodFromInput) periodFromInput.value = item.periodFrom;

            const periodToInput = clone.querySelector('[data-field="periodTo"]');
            if (periodToInput) periodToInput.value = item.periodTo;

            const daysInput = clone.querySelector('[data-field="days"]');
            if (daysInput) daysInput.value = item.days;

            const hoursPerDayInput = clone.querySelector('[data-field="hoursPerDay"]');
            if (hoursPerDayInput) hoursPerDayInput.value = item.hoursPerDay;

            const qtyInput = clone.querySelector('[data-field="quantity"]');
            if (qtyInput) qtyInput.value = item.quantity;

            const rateInput = clone.querySelector('[data-field="rate"]');
            if (rateInput) rateInput.value = item.rate;

            const amountInput = clone.querySelector('[data-field="amount"]');
            if (amountInput) amountInput.value = item.amount;

            container.appendChild(clone);
          });
        } catch (error) {
          console.error('Error rendering line items:', error);
        }
      }

      buildPreview() {
        try {
          Utils.setAccentColor(Utils.$(CONFIG.SELECTORS.color).value);

          const currency = Utils.$(CONFIG.SELECTORS.currency).value;
          const subtotal = this.state.getSubtotal();
          const taxPct = parseFloat(Utils.$(CONFIG.SELECTORS.tax).value || 0);
          const tax = subtotal * (taxPct / 100);
          const discount = parseFloat(Utils.$(CONFIG.SELECTORS.discount).value || 0);
      const total = Math.max(0, subtotal + tax - discount);

          const template = document.getElementById('tpl-invoice');
          if (!template) {
            console.error('Invoice template not found');
            return;
          }

          const invoice = document.importNode(template.content, true);

          // Header
          const pNum = invoice.getElementById('p_num');
          if (pNum) pNum.textContent = Utils.$(CONFIG.SELECTORS.number).value || 'INV-0001';

          const pDate = invoice.getElementById('p_date');
          if (pDate) pDate.textContent = Utils.$(CONFIG.SELECTORS.date).value || Utils.getTodayISO();

          const pDue = invoice.getElementById('p_due');
          if (pDue) pDue.textContent = Utils.$(CONFIG.SELECTORS.due).value || Utils.getTodayISO();

          // Parties
          const pFrom = invoice.getElementById('p_from');
          if (pFrom) {
            pFrom.innerHTML = `${Utils.$(CONFIG.SELECTORS.freelancer).value}<br/><span class="muted">${Utils.$(CONFIG.SELECTORS.email).value}</span>`;
          }

          const pTo = invoice.getElementById('p_to');
          if (pTo) pTo.textContent = Utils.$(CONFIG.SELECTORS.client).value || 'Client Name';

          // Line items table
          const tbody = invoice.getElementById('p_items');
          if (tbody) {
            this.state.lineItems.forEach(item => {
              const tr = document.createElement('tr');
              const days = item.days ? item.days : 'â€”';
              const hours = item.quantity ? item.quantity : 'â€”';
              
              // Format period
              let period = 'â€”';
              if (item.periodFrom && item.periodTo) {
                period = `${item.periodFrom} to ${item.periodTo}`;
              } else if (item.periodFrom) {
                period = `From ${item.periodFrom}`;
              } else if (item.periodTo) {
                period = `Until ${item.periodTo}`;
              }
              
              tr.innerHTML = `
                <td>${item.description || 'â€”'}</td>
                <td style="white-space: nowrap;">${period}</td>
                <td class="right">${days}</td>
                <td class="right">${hours}</td>
                <td class="right">${Utils.formatMoney(item.rate, currency)}</td>
                <td class="right currency">${Utils.formatMoney(item.amount, currency)}</td>
              `;
              tbody.appendChild(tr);
            });
          }

          // Totals
          const pSubtotal = invoice.getElementById('p_subtotal');
          if (pSubtotal) pSubtotal.textContent = Utils.formatMoney(subtotal, currency);

          const taxRow = invoice.getElementById('p_tax_row');
          const pTax = invoice.getElementById('p_tax');
          if (taxRow && pTax) {
            if (taxPct > 0) {
              taxRow.style.display = 'flex';
              pTax.textContent = `${taxPct}% (${Utils.formatMoney(tax, currency)})`;
            } else {
              taxRow.style.display = 'none';
            }
          }

          const discountRow = invoice.getElementById('p_discount_row');
          const pDiscount = invoice.getElementById('p_discount');
          if (discountRow && pDiscount) {
            if (discount > 0) {
              discountRow.style.display = 'flex';
              pDiscount.textContent = Utils.formatMoney(discount, currency);
            } else {
              discountRow.style.display = 'none';
            }
          }

          const pTotal = invoice.getElementById('p_total');
          if (pTotal) pTotal.textContent = Utils.formatMoney(total, currency);

          // Notes
          const noteText = Utils.$(CONFIG.SELECTORS.note).value.trim();
          const noteWrap = invoice.getElementById('p_note_wrap');
          if (noteWrap) {
            if (noteText) {
              noteWrap.style.display = 'block';
              noteWrap.textContent = noteText;
            } else {
              noteWrap.style.display = 'none';
            }
          }

          // Render
          const previewEl = Utils.$(CONFIG.SELECTORS.preview);
          if (previewEl) {
            previewEl.innerHTML = '';
            previewEl.appendChild(invoice);
          }
        } catch (error) {
          console.error('Error building preview:', error);
        }
      }

      print() {
        this.buildPreview();
        this.updateDocumentTitle();
        setTimeout(() => window.print(), 30);
      }

      showEmailModal() {
        const modal = document.getElementById('emailModal');
        const emailInput = document.getElementById('modal_client_email');
        const errorDiv = document.getElementById('modal_error');
        
        // Clear previous input and errors
        if (emailInput) emailInput.value = '';
        if (errorDiv) errorDiv.style.display = 'none';
        
        // Show modal
        if (modal) {
          modal.classList.add('show');
          // Focus on input after animation
          setTimeout(() => {
            if (emailInput) emailInput.focus();
          }, 100);
        }
        
        // Prevent body scroll
        document.body.style.overflow = 'hidden';
      }

      closeEmailModal() {
        const modal = document.getElementById('emailModal');
        if (modal) {
          modal.classList.remove('show');
        }
        
        // Restore body scroll
        document.body.style.overflow = '';
      }

      validateEmail(email) {
        const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return re.test(email);
      }

      showModalError(message) {
        const errorDiv = document.getElementById('modal_error');
        if (errorDiv) {
          errorDiv.textContent = message;
          errorDiv.style.display = 'block';
        }
      }

      hideModalError() {
        const errorDiv = document.getElementById('modal_error');
        if (errorDiv) {
          errorDiv.style.display = 'none';
        }
      }

      confirmSendEmail() {
        const emailInput = document.getElementById('modal_client_email');
        const email = emailInput ? emailInput.value.trim() : '';
        
        // Hide previous errors
        this.hideModalError();
        
        // Validate email
        if (!email) {
          this.showModalError('Please enter an email address');
          if (emailInput) emailInput.focus();
          return;
        }
        
        if (!this.validateEmail(email)) {
          this.showModalError('Please enter a valid email address');
          if (emailInput) emailInput.focus();
          return;
        }
        
        // Close modal and send email
        this.closeEmailModal();
        this.sendEmail(email);
      }

      connectGmail() {
        if (!GMAIL_CONFIG.CLIENT_ID || GMAIL_CONFIG.CLIENT_ID === 'YOUR_CLIENT_ID_HERE.apps.googleusercontent.com') {
          alert('âš ï¸ Gmail API Not Configured\n\nTo enable direct PDF email attachment:\n\n1. Go to https://console.cloud.google.com\n2. Create a project and enable Gmail API\n3. Create OAuth 2.0 Client ID\n4. Replace CLIENT_ID in the code\n\nFor now, I\'ll use the simple method (PDF downloads, you attach manually).');
          return;
        }

        try {
          // Initialize Google Identity Services
          google.accounts.oauth2.initTokenClient({
            client_id: GMAIL_CONFIG.CLIENT_ID,
            scope: GMAIL_CONFIG.SCOPES,
            callback: (response) => {
              if (response.access_token) {
                gmailAccessToken = response.access_token;
                gmailAuthorized = true;
                
                // Get user email
                this.getGmailProfile();
              }
            },
          }).requestAccessToken();
        } catch (error) {
          console.error('Gmail auth error:', error);
          alert('Gmail connection failed. Check console for details.');
        }
      }

      async getGmailProfile() {
        try {
          const response = await fetch('https://www.googleapis.com/gmail/v1/users/me/profile', {
            headers: {
              'Authorization': `Bearer ${gmailAccessToken}`
            }
          });
          const data = await response.json();
          gmailUserEmail = data.emailAddress;
          this.updateGmailStatus(true);
        } catch (error) {
          console.error('Error getting Gmail profile:', error);
          gmailAuthorized = false;
          this.updateGmailStatus(false);
        }
      }

      updateGmailStatus(connected) {
        const icon = Utils.$(CONFIG.SELECTORS.gmailStatusIcon);
        const text = Utils.$(CONFIG.SELECTORS.gmailStatusText);
        const email = Utils.$(CONFIG.SELECTORS.gmailStatusEmail);
        const btn = Utils.$(CONFIG.SELECTORS.connectGmailBtn);

        if (connected && gmailUserEmail) {
          if (icon) icon.textContent = 'âœ…';
          if (text) text.textContent = 'Gmail Connected';
          if (email) email.textContent = gmailUserEmail;
          if (btn) {
            btn.innerHTML = '<span style="margin-right: 6px;">ðŸ”„</span> Reconnect';
          }
        } else {
          if (icon) icon.textContent = 'âšª';
          if (text) text.textContent = 'Gmail Not Connected';
          if (email) email.textContent = '';
          if (btn) {
            btn.innerHTML = '<span style="margin-right: 6px;">ðŸ”—</span> Connect Gmail';
          }
        }
      }

      async sendEmail(clientEmail) {
        this.buildPreview();
        
        const clientName = Utils.$(CONFIG.SELECTORS.client).value;
        const invoiceNumber = Utils.$(CONFIG.SELECTORS.number).value;
        const freelancerName = Utils.$(CONFIG.SELECTORS.freelancer).value;
        const dueDate = Utils.$(CONFIG.SELECTORS.due).value;

        // If Gmail not connected, use simple mailto method
        if (!gmailAuthorized || !gmailAccessToken) {
          await this.sendEmailSimple(clientEmail);
          return;
        }

        // Show loading state
        const sendBtn = Utils.$(CONFIG.SELECTORS.sendEmailBtn);
        const originalText = sendBtn.innerHTML;
        sendBtn.innerHTML = '<span style="font-size: 16px; margin-right: 6px;">â³</span> Generating PDF...';
        sendBtn.disabled = true;

        try {
          // Get period from first line item
          const firstItem = this.state.lineItems[0];
          let period = '';
          if (firstItem && firstItem.periodFrom && firstItem.periodTo) {
            period = `${firstItem.periodFrom} to ${firstItem.periodTo}`;
          }

          // Calculate total
          const subtotal = this.state.getSubtotal();
          const currency = Utils.$(CONFIG.SELECTORS.currency).value;
          const taxPct = parseFloat(Utils.$(CONFIG.SELECTORS.tax).value || 0);
          const tax = subtotal * (taxPct / 100);
          const discount = parseFloat(Utils.$(CONFIG.SELECTORS.discount).value || 0);
          const total = Math.max(0, subtotal + tax - discount);

          // Generate filename
          let filename = 'Invoice';
          if (period) {
            filename = `Invoice_${invoiceNumber}_${period.replace(/ to /g, '_to_')}`;
          } else {
            filename = `Invoice_${invoiceNumber}`;
          }
          filename = filename.replace(/\s+/g, '_');

          // Generate PDF as blob
          const element = document.querySelector('.sheet');
          const opt = {
            margin: [15, 15, 15, 15],
            filename: `${filename}.pdf`,
            image: { type: 'png', quality: 1.0 },
            html2canvas: { 
              scale: 3,
              useCORS: true,
              logging: false,
              letterRendering: true,
              backgroundColor: '#ffffff'
            },
            jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait', compress: true }
          };

          sendBtn.innerHTML = '<span style="font-size: 16px; margin-right: 6px;">ðŸ“§</span> Sending Email...';

          // Generate PDF as blob
          const pdfBlob = await html2pdf().set(opt).from(element).outputPdf('blob');
          
          // Convert blob to base64
          const reader = new FileReader();
          const pdfBase64 = await new Promise((resolve, reject) => {
            reader.onload = () => resolve(reader.result.split(',')[1]);
            reader.onerror = reject;
            reader.readAsDataURL(pdfBlob);
          });

          // Email subject
          const subject = period 
            ? `Invoice ${invoiceNumber} | ${period}` 
            : `Invoice ${invoiceNumber}`;

          // Email body
          const body = `Hi ${clientName},

Please find the attached invoice.

Invoice #${invoiceNumber}${period ? ` | Period: ${period}` : ''}
Amount Due: ${Utils.formatMoney(total, currency)}
Due Date: ${dueDate}

Thank you!

${freelancerName}`;

          // Create email with attachment (RFC 2822 format)
          const boundary = '----=_Part_' + Date.now();
          const email = [
            'Content-Type: multipart/mixed; boundary="' + boundary + '"',
            'MIME-Version: 1.0',
            'To: ' + clientEmail,
            'Subject: ' + subject,
            '',
            '--' + boundary,
            'Content-Type: text/plain; charset="UTF-8"',
            'MIME-Version: 1.0',
            'Content-Transfer-Encoding: 7bit',
            '',
            body,
            '',
            '--' + boundary,
            'Content-Type: application/pdf; name="' + filename + '.pdf"',
            'MIME-Version: 1.0',
            'Content-Transfer-Encoding: base64',
            'Content-Disposition: attachment; filename="' + filename + '.pdf"',
            '',
            pdfBase64,
            '--' + boundary + '--'
          ].join('\r\n');

          // Encode email
          const encodedEmail = btoa(unescape(encodeURIComponent(email)))
            .replace(/\+/g, '-')
            .replace(/\//g, '_')
            .replace(/=+$/, '');

          // Send via Gmail API
          const response = await fetch('https://www.googleapis.com/gmail/v1/users/me/messages/send', {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${gmailAccessToken}`,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              raw: encodedEmail
            })
          });

          if (!response.ok) {
            throw new Error(`Gmail API error: ${response.status}`);
          }

          // Reset button and show success
          sendBtn.innerHTML = originalText;
          sendBtn.disabled = false;

          alert(`âœ… Email Sent Successfully!\n\nâœ“ Invoice sent to: ${clientEmail}\nâœ“ PDF attached: ${filename}.pdf\nâœ“ Subject: ${subject}\n\nThe email has been sent from your Gmail account!`);

        } catch (error) {
          console.error('Error sending email:', error);
          const sendBtn = Utils.$(CONFIG.SELECTORS.sendEmailBtn);
          sendBtn.innerHTML = originalText;
          sendBtn.disabled = false;
          
          // Fallback to simple method
          if (confirm('Gmail API send failed. Use simple method (download PDF + open Gmail)?')) {
            await this.sendEmailSimple();
          }
        }
      }

      async sendEmailSimple(clientEmail) {
        this.buildPreview();
        
        const clientName = Utils.$(CONFIG.SELECTORS.client).value;
        const invoiceNumber = Utils.$(CONFIG.SELECTORS.number).value;
        const freelancerName = Utils.$(CONFIG.SELECTORS.freelancer).value;
        const dueDate = Utils.$(CONFIG.SELECTORS.due).value;
        
        // Show loading state
        const sendBtn = Utils.$(CONFIG.SELECTORS.sendEmailBtn);
        const originalText = sendBtn.innerHTML;
        sendBtn.innerHTML = '<span style="font-size: 16px; margin-right: 6px;">â³</span> Generating PDF...';
        sendBtn.disabled = true;

        try {
          // Get period from first line item
          const firstItem = this.state.lineItems[0];
          let period = '';
          if (firstItem && firstItem.periodFrom && firstItem.periodTo) {
            period = `${firstItem.periodFrom} to ${firstItem.periodTo}`;
          }

          // Calculate total
          const subtotal = this.state.getSubtotal();
          const currency = Utils.$(CONFIG.SELECTORS.currency).value;
          const taxPct = parseFloat(Utils.$(CONFIG.SELECTORS.tax).value || 0);
          const tax = subtotal * (taxPct / 100);
          const discount = parseFloat(Utils.$(CONFIG.SELECTORS.discount).value || 0);
          const total = Math.max(0, subtotal + tax - discount);

          // Generate filename
          let filename = 'Invoice';
          if (period) {
            filename = `Invoice_${invoiceNumber}_${period.replace(/ to /g, '_to_')}`;
          } else {
            filename = `Invoice_${invoiceNumber}`;
          }
          filename = filename.replace(/\s+/g, '_');

          // Generate PDF
          const element = document.querySelector('.sheet');
          const opt = {
            margin: [15, 15, 15, 15],
            filename: `${filename}.pdf`,
            image: { type: 'png', quality: 1.0 },
            html2canvas: { 
              scale: 3,
              useCORS: true,
              logging: false,
              letterRendering: true,
              backgroundColor: '#ffffff'
            },
            jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait', compress: true }
          };

          // Generate and download PDF
          await html2pdf().set(opt).from(element).save();

          // Simple subject
          const subject = period 
            ? `Invoice ${invoiceNumber} | ${period}` 
            : `Invoice ${invoiceNumber}`;

          // Concise email body
          const body = `Hi ${clientName},

Please find the attached invoice.

Invoice #${invoiceNumber}${period ? ` | Period: ${period}` : ''}
Amount Due: ${Utils.formatMoney(total, currency)}
Due Date: ${dueDate}

Thank you!

${freelancerName}`;

          // Open Gmail with pre-filled content
          const gmailUrl = `https://mail.google.com/mail/?view=cm&fs=1&to=${encodeURIComponent(clientEmail)}&su=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
          
          // Small delay to let PDF download start
          setTimeout(() => {
            window.open(gmailUrl, '_blank');
            
            // Reset button and show success
            sendBtn.innerHTML = originalText;
            sendBtn.disabled = false;
            
            setTimeout(() => {
              const message = `âœ… PDF Downloaded!\n\n` +
                `âœ“ File: "${filename}.pdf"\n` +
                `âœ“ Gmail opened with pre-filled message\n\n` +
                `ðŸ“Ž NEXT STEP:\n` +
                `In Gmail, click the paperclip icon and attach the PDF\n\n` +
                `To: ${clientEmail}\n\n` +
                `ðŸ’¡ TIP: Connect your Gmail account to send with automatic PDF attachment!`;
              alert(message);
            }, 500);
          }, 1000);

        } catch (error) {
          console.error('Error generating PDF:', error);
          const sendBtn = Utils.$(CONFIG.SELECTORS.sendEmailBtn);
          sendBtn.innerHTML = originalText;
          sendBtn.disabled = false;
          alert('Error generating PDF. Please try using the "Print / PDF" button instead.');
        }
      }

      updateDocumentTitle() {
        // Get the first line item's period dates
        const firstItem = this.state.lineItems[0];
        let filename = 'Invoice';
        
        if (firstItem && firstItem.periodFrom && firstItem.periodTo) {
          filename = `Invoice_${firstItem.periodFrom}_to_${firstItem.periodTo}`;
        } else if (firstItem && firstItem.periodFrom) {
          filename = `Invoice_from_${firstItem.periodFrom}`;
        } else if (firstItem && firstItem.periodTo) {
          filename = `Invoice_to_${firstItem.periodTo}`;
        } else {
          // Fallback to invoice dates if no period is set
          const invoiceDate = Utils.$(CONFIG.SELECTORS.date).value;
          const dueDate = Utils.$(CONFIG.SELECTORS.due).value;
          if (invoiceDate && dueDate) {
            filename = `Invoice_${invoiceDate}_to_${dueDate}`;
          } else if (invoiceDate) {
            filename = `Invoice_${invoiceDate}`;
          } else {
            // Use invoice number as final fallback
            const invoiceNum = Utils.$(CONFIG.SELECTORS.number).value || '0001';
            filename = `Invoice_${invoiceNum}`;
          }
        }
        
        document.title = filename;
      }
    }

    // ============================================================================
    // INITIALIZATION
    // ============================================================================
    document.addEventListener('DOMContentLoaded', () => {
      const state = new InvoiceState();
      new InvoiceBuilder(state);
    });
  </script>
</body>
</html>



